<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalyst Behavior Insights Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .timer-active { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen">

        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-8 h-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 01-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 013.09-3.09L9 6l.813 2.846a4.5 4.5 0 013.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 01-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.455-2.456L12.75 18l1.178-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.25 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" />
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-900">Catalyst</h1>
                </div>
                <div id="nav-buttons" class="flex items-center space-x-2">
                    <!-- Nav buttons will be dynamically added here -->
                </div>
                 <div class="text-xs text-gray-500">User ID: <span id="userIdDisplay"></span></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Loading Spinner -->
            <div id="loading" class="text-center py-20">
                <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-medium text-gray-600">Loading Catalyst...</p>
            </div>

            <!-- Student Selection View -->
            <div id="student-selection-view" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Select Student</h2>
                <div id="student-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Student cards will be dynamically added here -->
                </div>
            </div>

            <!-- "In-the-Moment" Logging View -->
            <div id="logging-view" class="hidden">
                <!-- Logging content will be dynamically added here -->
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden">
                <!-- Dashboard content will be dynamically added here -->
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                 <h2 class="text-3xl font-bold mb-6">Settings</h2>
                <div class="space-y-12">
                    <!-- Student Management -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Manage Students</h3>
                        <form id="add-student-form" class="flex items-end space-x-4">
                            <div class="flex-grow">
                                <label for="student-name" class="block text-sm font-medium text-gray-700">New Student Name</label>
                                <input type="text" id="student-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Deontae Harper" required>
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add Student</button>
                        </form>
                        <div id="student-management-list" class="mt-6 space-y-2"></div>
                    </div>

                    <!-- Behavior Management -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Manage Behaviors (Operational Definitions)</h3>
                        <form id="add-behavior-form" class="space-y-4">
                            <input type="text" id="behavior-name" placeholder="Behavior Name (e.g., Aggression)" class="block w-full rounded-md border-gray-300 shadow-sm" required>
                            <textarea id="behavior-definition" placeholder="Objective, observable, and measurable definition" class="block w-full rounded-md border-gray-300 shadow-sm" rows="2" required></textarea>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Measurement Type</label>
                                <select id="behavior-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="frequency">Frequency (Tally Count)</option>
                                    <option value="duration">Duration (Timer)</option>
                                </select>
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700">Add Behavior</button>
                        </form>
                        <div id="behavior-management-list" class="mt-6 space-y-2"></div>
                    </div>

                     <!-- Settings Management -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Manage Settings/Environments</h3>
                        <form id="add-setting-form" class="flex items-end space-x-4">
                            <div class="flex-grow">
                                <label for="setting-name" class="block text-sm font-medium text-gray-700">New Setting Name</label>
                                <input type="text" id="setting-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., Library" required>
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700">Add Setting</button>
                        </form>
                        <div id="setting-management-list" class="mt-6 space-y-2"></div>
                    </div>
                </div>
            </div>

        </main>

    </div>

    <!-- Modal for Notes -->
    <div id="notes-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add Anecdotal Note</h3>
                <div class="mt-2 px-7 py-3">
                    <textarea id="modal-notes-textarea" class="w-full h-40 p-2 border rounded-md" placeholder="Capture the context, the nuance, the un-quantifiable human element..."></textarea>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-note-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">Save Note</button>
                    <button id="cancel-note-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="confirm-title" class="text-lg leading-6 font-medium text-gray-900 text-center">Confirmation</h3>
                <p id="confirm-message" class="text-sm text-gray-500 mt-2 text-center">Are you sure?</p>
                <div class="flex justify-center items-center px-4 py-3 mt-4 space-x-4">
                    <button id="confirm-yes-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-1/2 shadow-sm hover:bg-red-600 focus:outline-none">Yes</button>
                    <button id="confirm-no-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-1/2 shadow-sm hover:bg-gray-300 focus:outline-none">No</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP STATE & CONFIG ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "your-fallback-api-key", authDomain: "your-fallback-auth-domain", projectId: "your-fallback-project-id" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'catalyst-dev';
        
        let app, auth, db, userId;
        let students = [], behaviors = [], settings = [], incidents = [];
        let currentStudent = null;
        let activeTimers = {};
        let currentIncidentData = {};
        let behaviorFrequencies = {};

        // --- UI ELEMENTS ---
        const loadingEl = document.getElementById('loading');
        const studentSelectionView = document.getElementById('student-selection-view');
        const loggingView = document.getElementById('logging-view');
        const dashboardView = document.getElementById('dashboard-view');
        const settingsView = document.getElementById('settings-view');
        const views = [studentSelectionView, loggingView, dashboardView, settingsView];
        
        // --- INITIALIZATION ---
        async function main() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    await setupInitialData();
                    setupListeners();
                    navigateTo('students');
                } else {
                   try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        loadingEl.innerHTML = `<p class="text-red-500">Authentication failed. Please refresh.</p>`;
                    }
                }
                loadingEl.classList.add('hidden');
            });
        }

        async function setupInitialData() {
            const settingsRef = doc(db, `artifacts/${appId}/public/data/app_settings`, 'config');
            const settingsSnap = await getDoc(settingsRef);

            if (!settingsSnap.exists()) {
                console.log("First time setup: Seeding initial data...");
                const batch = writeBatch(db);
                
                const defaultBehaviors = [
                    { name: 'Aggression', definition: 'Hitting, kicking, grabbing, scratching, biting, pulling, shoving, throwing.', type: 'frequency' },
                    { name: 'Task Refusal', definition: 'Saying no, turning away, hiding, clearing desk, throwing materials.', type: 'duration' },
                    { name: 'Elopement', definition: 'Running out of classroom, playground or any other assigned space.', type: 'duration' }
                ];

                const defaultSettings = ['Cafeteria', 'Classroom', 'Group Work', 'Hallway', 'Independent Work', 'Specials', 'Restroom', 'Other'];
                
                defaultBehaviors.forEach(b => {
                    const newBehRef = doc(collection(db, `artifacts/${appId}/public/data/behaviors`));
                    batch.set(newBehRef, b);
                });

                defaultSettings.forEach(s => {
                    const newSetRef = doc(collection(db, `artifacts/${appId}/public/data/settings`));
                    batch.set(newSetRef, { name: s });
                });

                batch.set(settingsRef, { initialized: true, version: '1.0' });
                await batch.commit();
            }
        }
        
        // --- DATA LISTENERS (REAL-TIME) ---
        function setupListeners() {
            // Students
            const studentsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/students`));
            onSnapshot(studentsQuery, (snapshot) => {
                students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(studentSelectionView.style.display !== 'none') renderStudentSelection();
                renderStudentManagementList();
            });

            // Behaviors (Public)
            const behaviorsQuery = query(collection(db, `artifacts/${appId}/public/data/behaviors`));
            onSnapshot(behaviorsQuery, (snapshot) => {
                behaviors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBehaviorManagementList();
            });

            // Settings (Public)
            const settingsQuery = query(collection(db, `artifacts/${appId}/public/data/settings`));
            onSnapshot(settingsQuery, (snapshot) => {
                settings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSettingManagementList();
            });
        }


        // --- NAVIGATION ---
        function navigateTo(viewName, studentId = null) {
            views.forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('#nav-buttons button').forEach(b => b.classList.replace('bg-indigo-600', 'bg-gray-600'));
            
            let activeBtn;
            switch(viewName) {
                case 'students':
                    studentSelectionView.classList.remove('hidden');
                    renderStudentSelection();
                    activeBtn = document.getElementById('nav-students');
                    break;
                case 'logging':
                    if (studentId) {
                        currentStudent = students.find(s => s.id === studentId);
                        if (currentStudent) {
                            loggingView.classList.remove('hidden');
                            renderLoggingView();
                        } else {
                            console.error("Student not found for logging");
                            navigateTo('students');
                        }
                    }
                    break;
                case 'dashboard':
                     if (studentId) {
                        currentStudent = students.find(s => s.id === studentId);
                        if (currentStudent) {
                            dashboardView.classList.remove('hidden');
                            renderDashboardView();
                        } else {
                            console.error("Student not found for dashboard");
                            navigateTo('students');
                        }
                    }
                    break;
                case 'settings':
                    settingsView.classList.remove('hidden');
                    activeBtn = document.getElementById('nav-settings');
                    break;
            }
            if (activeBtn) activeBtn.classList.replace('bg-gray-600', 'bg-indigo-600');
            renderNavButtons(viewName);
        }
        
        function renderNavButtons(activeView) {
            const navContainer = document.getElementById('nav-buttons');
            let buttonsHTML = '';

            if (activeView === 'students' || activeView === 'settings') {
                buttonsHTML = `
                    <button id="nav-students" class="px-3 py-2 rounded-md text-sm font-medium text-white ${activeView === 'students' ? 'bg-indigo-600' : 'bg-gray-600 hover:bg-indigo-700'}">Students</button>
                    <button id="nav-settings" class="px-3 py-2 rounded-md text-sm font-medium text-white ${activeView === 'settings' ? 'bg-indigo-600' : 'bg-gray-600 hover:bg-indigo-700'}">Settings</button>
                `;
            } else if (activeView === 'logging' || activeView === 'dashboard') {
                 buttonsHTML = `
                    <button id="nav-back" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-gray-600 hover:bg-indigo-700">Back to Students</button>
                    <button id="nav-logging-tab" class="px-3 py-2 rounded-md text-sm font-medium text-white ${activeView === 'logging' ? 'bg-indigo-600' : 'bg-gray-600 hover:bg-indigo-700'}">Log Data</button>
                    <button id="nav-dashboard-tab" class="px-3 py-2 rounded-md text-sm font-medium text-white ${activeView === 'dashboard' ? 'bg-indigo-600' : 'bg-gray-600 hover:bg-indigo-700'}">Dashboard</button>
                `;
            }
            navContainer.innerHTML = buttonsHTML;
            
            // Re-add event listeners
            document.getElementById('nav-students')?.addEventListener('click', () => navigateTo('students'));
            document.getElementById('nav-settings')?.addEventListener('click', () => navigateTo('settings'));
            document.getElementById('nav-back')?.addEventListener('click', () => navigateTo('students'));
            document.getElementById('nav-logging-tab')?.addEventListener('click', () => navigateTo('logging', currentStudent.id));
            document.getElementById('nav-dashboard-tab')?.addEventListener('click', () => navigateTo('dashboard', currentStudent.id));
        }

        // --- RENDER FUNCTIONS ---

        function renderStudentSelection() {
            const listEl = document.getElementById('student-list');
            if (students.length === 0) {
                listEl.innerHTML = `<p class="col-span-full text-center text-gray-500">No students found. Go to Settings to add your first student.</p>`;
                return;
            }
            listEl.innerHTML = students.map(student => `
                <div class="student-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer p-6 flex flex-col items-center justify-center text-center" data-id="${student.id}">
                    <div class="w-20 h-20 rounded-full bg-indigo-100 flex items-center justify-center mb-4">
                        <span class="text-3xl font-bold text-indigo-600">${student.name.charAt(0)}</span>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">${student.name}</h3>
                </div>
            `).join('');
        }
        
        function renderLoggingView() {
            resetLoggingState();
            const settingsOptions = settings.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            const behaviorButtons = behaviors.map(b => {
                if (b.type === 'frequency') {
                    return `<div class="relative">
                                <button data-behavior-id="${b.id}" data-behavior-type="frequency" class="behavior-btn w-full bg-white text-indigo-700 font-semibold py-3 px-4 border border-indigo-200 rounded-lg shadow-sm hover:bg-indigo-50">
                                    ${b.name}
                                </button>
                                <span id="freq-count-${b.id}" class="absolute -top-2 -right-2 bg-indigo-600 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center hidden">0</span>
                            </div>`;
                } else { // duration
                    return `<button id="timer-btn-${b.id}" data-behavior-id="${b.id}" data-behavior-type="duration" class="behavior-btn w-full bg-white text-teal-700 font-semibold py-3 px-4 border border-teal-200 rounded-lg shadow-sm hover:bg-teal-50">
                                ${b.name} (<span id="timer-display-${b.id}">00:00</span>)
                            </button>`;
                }
            }).join('');

            loggingView.innerHTML = `
                <h2 class="text-3xl font-bold mb-2">Logging for: <span class="text-indigo-600">${currentStudent.name}</span></h2>
                <p class="text-gray-500 mb-6">Timestamp: ${new Date().toLocaleString()}</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Left Column: Core Logging -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">1. Antecedent (Setting/Environment)</h3>
                            <select id="setting-select" class="w-full rounded-md border-gray-300 shadow-sm">
                                ${settingsOptions}
                            </select>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">2. Behavior(s)</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                ${behaviorButtons}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">3. Intensity</h3>
                             <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg">
                                <button data-intensity="1" class="intensity-btn flex-1 p-2 rounded-md">1 (Low)</button>
                                <button data-intensity="2" class="intensity-btn flex-1 p-2 rounded-md">2 (Mod)</button>
                                <button data-intensity="3" class="intensity-btn flex-1 p-2 rounded-md">3 (High)</button>
                                <button data-intensity="4" class="intensity-btn flex-1 p-2 rounded-md">4 (Severe)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Consequence/Intervention -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">4. Replacement Behavior Prompted</h3>
                            <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg">
                                <button data-replacement="Functional Communication for Break" class="replacement-btn flex-1 p-2 rounded-md">Break Comm.</button>
                                <button data-replacement="Appropriately help-seeking" class="replacement-btn flex-1 p-2 rounded-md">Help Seeking</button>
                                <button data-replacement="None" class="replacement-btn flex-1 p-2 rounded-md bg-indigo-200">None</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">5. Cool Down / Recovery</h3>
                            <div id="cooldown-timer-controls" class="flex items-center space-x-4">
                                <button id="cooldown-start-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Start Cooldown</button>
                                <span id="cooldown-timer-display" class="text-xl font-mono">00:00</span>
                            </div>
                            <div id="cooldown-support-controls" class="mt-3 hidden">
                               <label class="block text-sm font-medium text-gray-700">Support Level</label>
                               <select id="cooldown-support-level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                   <option>Independent</option>
                                   <option>Prompted</option>
                                   <option>Removed from environment</option>
                               </select>
                            </div>
                        </div>
                         <div>
                            <h3 class="text-lg font-semibold mb-3">6. The Sacred Note</h3>
                            <p id="note-preview" class="text-gray-600 italic bg-gray-100 p-3 rounded-md min-h-[40px] cursor-pointer hover:bg-gray-200">Click to add a note...</p>
                        </div>
                    </div>
                </div>

                <div class="mt-10 text-center">
                    <button id="save-incident-btn" class="bg-green-600 text-white font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-green-700 text-xl transition-transform transform hover:scale-105">Save Incident</button>
                </div>
            `;
            // Set default selections
            document.querySelector('.intensity-btn')?.classList.add('bg-indigo-200');
            document.querySelector('.replacement-btn[data-replacement="None"]')?.classList.add('bg-indigo-200');
        }
        
        function renderDashboardView() {
            dashboardView.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Dashboard: <span class="text-indigo-600">${currentStudent.name}</span></h2>
                    <button id="generate-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        <span>Generate PDF Report</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><canvas id="behavior-timeline-chart"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><canvas id="behavior-by-setting-chart"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><canvas id="behavior-vs-replacement-chart"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><canvas id="intensity-chart"></canvas></div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Incident Log & Notes</h3>
                    <div id="incident-log" class="max-h-96 overflow-y-auto space-y-4"></div>
                </div>
            `;
            loadDashboardData();
        }

        function renderStudentManagementList() {
            const listEl = document.getElementById('student-management-list');
            listEl.innerHTML = students.map(s => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md">
                    <span>${s.name}</span>
                    <button data-id="${s.id}" class="delete-student-btn text-red-500 hover:text-red-700">Delete</button>
                </div>
            `).join('');
        }
        
        function renderBehaviorManagementList() {
            const listEl = document.getElementById('behavior-management-list');
            listEl.innerHTML = behaviors.map(b => `
                <div class="p-3 bg-gray-50 rounded-md">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold">${b.name} <span class="text-xs font-normal text-gray-500">(${b.type})</span></p>
                            <p class="text-sm text-gray-600">${b.definition}</p>
                        </div>
                        <button data-id="${b.id}" class="delete-behavior-btn text-red-500 hover:text-red-700">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderSettingManagementList() {
            const listEl = document.getElementById('setting-management-list');
            listEl.innerHTML = settings.map(s => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md">
                    <span>${s.name}</span>
                    <button data-id="${s.id}" class="delete-setting-btn text-red-500 hover:text-red-700">Delete</button>
                </div>
            `).join('');
        }
        
        // --- LOGGING VIEW LOGIC ---
        function resetLoggingState() {
            Object.values(activeTimers).forEach(timer => clearInterval(timer.interval));
            activeTimers = {};
            behaviorFrequencies = {};
            currentIncidentData = {
                timestamp: new Date(),
                behaviors: [],
                intensity: 1,
                replacementBehavior: 'None',
                cooldown: { duration: 0, support: null },
                notes: ''
            };
        }

        function handleBehaviorClick(e) {
            const button = e.target.closest('.behavior-btn');
            if (!button) return;

            const behaviorId = button.dataset.behaviorId;
            const behaviorType = button.dataset.behaviorType;
            const behavior = behaviors.find(b => b.id === behaviorId);

            if (behaviorType === 'frequency') {
                behaviorFrequencies[behaviorId] = (behaviorFrequencies[behaviorId] || 0) + 1;
                const countBadge = document.getElementById(`freq-count-${behaviorId}`);
                countBadge.textContent = behaviorFrequencies[behaviorId];
                countBadge.classList.remove('hidden');
            } else if (behaviorType === 'duration') {
                toggleTimer(behaviorId, button);
            }
        }

        function toggleTimer(behaviorId, button) {
            const timerDisplay = document.getElementById(`timer-display-${behaviorId}`);
            if (activeTimers[behaviorId]) { // Stop timer
                clearInterval(activeTimers[behaviorId].interval);
                button.classList.remove('bg-red-200', 'timer-active', 'text-red-800');
                button.classList.add('bg-green-200', 'text-green-800');
                activeTimers[behaviorId].endTime = new Date();
                const duration = Math.round((activeTimers[behaviorId].endTime - activeTimers[behaviorId].startTime) / 1000);
                activeTimers[behaviorId].duration = duration;
            } else { // Start timer
                button.classList.remove('bg-green-200', 'text-green-800');
                button.classList.add('bg-red-200', 'timer-active', 'text-red-800');
                const startTime = new Date();
                activeTimers[behaviorId] = { startTime, duration: 0 };
                
                activeTimers[behaviorId].interval = setInterval(() => {
                    const elapsed = Math.round((new Date() - startTime) / 1000);
                    const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
                    const seconds = String(elapsed % 60).padStart(2, '0');
                    timerDisplay.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }
        }
        
        function toggleCooldownTimer() {
            const startBtn = document.getElementById('cooldown-start-btn');
            const timerDisplay = document.getElementById('cooldown-timer-display');
            const supportControls = document.getElementById('cooldown-support-controls');
            
            if (activeTimers.cooldown) { // Stop
                clearInterval(activeTimers.cooldown.interval);
                activeTimers.cooldown.endTime = new Date();
                const duration = Math.round((activeTimers.cooldown.endTime - activeTimers.cooldown.startTime) / 1000);
                currentIncidentData.cooldown.duration = duration;
                startBtn.textContent = "Cooldown Ended";
                startBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'timer-active');
                startBtn.classList.add('bg-green-500');
                startBtn.disabled = true;
                supportControls.classList.remove('hidden');
            } else { // Start
                const startTime = new Date();
                activeTimers.cooldown = { startTime };
                startBtn.textContent = "Stop Cooldown";
                startBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                startBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'timer-active');
                
                activeTimers.cooldown.interval = setInterval(() => {
                    const elapsed = Math.round((new Date() - startTime) / 1000);
                    const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
                    const seconds = String(elapsed % 60).padStart(2, '0');
                    timerDisplay.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }
        }

        async function saveIncident() {
            // Finalize data collection
            currentIncidentData.setting = document.getElementById('setting-select').value;
            if (activeTimers.cooldown) {
                 currentIncidentData.cooldown.support = document.getElementById('cooldown-support-level').value;
            }
            
            // Consolidate behaviors
            currentIncidentData.behaviors = [];
            for (const behaviorId in behaviorFrequencies) {
                currentIncidentData.behaviors.push({
                    id: behaviorId,
                    name: behaviors.find(b => b.id === behaviorId).name,
                    type: 'frequency',
                    value: behaviorFrequencies[behaviorId]
                });
            }
            for (const behaviorId in activeTimers) {
                if (behaviorId !== 'cooldown' && activeTimers[behaviorId].duration !== undefined) {
                    currentIncidentData.behaviors.push({
                        id: behaviorId,
                        name: behaviors.find(b => b.id === behaviorId).name,
                        type: 'duration',
                        value: activeTimers[behaviorId].duration // in seconds
                    });
                }
            }
            
            if (currentIncidentData.behaviors.length === 0) {
                showConfirmationModal("No behaviors were logged. Are you sure you want to save an incident with only contextual data?", () => {
                   // User chose to proceed without behaviors.
                   finalizeAndSave();
                });
                return;
            }

            finalizeAndSave();
        }
        
        async function finalizeAndSave() {
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/students/${currentStudent.id}/incidents`), currentIncidentData);
                console.log("Incident saved successfully!");
                navigateTo('dashboard', currentStudent.id);
            } catch (error) {
                console.error("Error saving incident: ", error);
                alert("Failed to save incident. Please check console for errors.");
            }
        }
        
        // --- DASHBOARD LOGIC ---
        async function loadDashboardData() {
            const incidentsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/students/${currentStudent.id}/incidents`));
            const snapshot = await getDocs(incidentsQuery);
            incidents = snapshot.docs.map(doc => ({id: doc.id, ...doc.data(), timestamp: doc.data().timestamp.toDate() })).sort((a,b) => a.timestamp - b.timestamp);
            
            renderAllCharts();
            renderIncidentLog();
        }
        
        let charts = {};
        function renderAllCharts() {
            // Destroy old charts if they exist
            Object.values(charts).forEach(chart => chart.destroy());

            if (incidents.length === 0) {
                dashboardView.querySelector('#behavior-timeline-chart').outerHTML = '<p class="text-center text-gray-500">No data yet to display charts.</p>';
                return;
            }

            // Chart 1: Behavior Timeline
            const timelineCtx = document.getElementById('behavior-timeline-chart').getContext('2d');
            const timelineLabels = incidents.map(inc => inc.timestamp.toLocaleTimeString());
            const timelineDatasets = behaviors.map(b => {
                return {
                    label: b.name,
                    data: incidents.map(inc => {
                        const behaviorData = inc.behaviors.find(ib => ib.id === b.id);
                        return behaviorData ? behaviorData.value : 0;
                    }),
                    borderColor: b.type === 'frequency' ? `rgba(79, 70, 229, 0.8)` : `rgba(13, 148, 136, 0.8)`,
                    backgroundColor: b.type === 'frequency' ? `rgba(79, 70, 229, 0.2)` : `rgba(13, 148, 136, 0.2)`,
                    tension: 0.1
                };
            });
            charts.timeline = new Chart(timelineCtx, {
                type: 'line',
                data: { labels: timelineLabels, datasets: timelineDatasets },
                options: { responsive: true, plugins: { title: { display: true, text: 'Behavior Occurrences Over Time' } } }
            });

            // Chart 2: Behavior by Setting
            const bySettingCtx = document.getElementById('behavior-by-setting-chart').getContext('2d');
            const settingLabels = [...new Set(incidents.map(i => i.setting))];
            const bySettingDatasets = behaviors.map(b => {
                return {
                    label: b.name,
                    data: settingLabels.map(setting => {
                        return incidents.filter(inc => inc.setting === setting)
                                        .reduce((sum, inc) => {
                                            const behaviorData = inc.behaviors.find(ib => ib.id === b.id);
                                            return sum + (behaviorData ? 1 : 0); // Count of incidents with this behavior
                                        }, 0);
                    }),
                    backgroundColor: b.type === 'frequency' ? `rgba(79, 70, 229, 0.6)` : `rgba(13, 148, 136, 0.6)`,
                };
            });
            charts.bySetting = new Chart(bySettingCtx, {
                type: 'bar',
                data: { labels: settingLabels, datasets: bySettingDatasets },
                options: { responsive: true, plugins: { title: { display: true, text: 'Incidents by Setting' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
            });

            // Chart 3: Problem vs Replacement
            const vsReplacementCtx = document.getElementById('behavior-vs-replacement-chart').getContext('2d');
            const totalIncidents = incidents.length;
            const incidentsWithReplacement = incidents.filter(i => i.replacementBehavior !== 'None').length;
            charts.vsReplacement = new Chart(vsReplacementCtx, {
                type: 'doughnut',
                data: {
                    labels: ['No Replacement Prompted', 'Replacement Prompted'],
                    datasets: [{
                        data: [totalIncidents - incidentsWithReplacement, incidentsWithReplacement],
                        backgroundColor: ['rgba(200, 200, 200, 0.6)', 'rgba(22, 163, 74, 0.6)']
                    }]
                },
                options: { responsive: true, plugins: { title: { display: true, text: 'Replacement Behavior Prompting' } } }
            });

            // Chart 4: Intensity
            const intensityCtx = document.getElementById('intensity-chart').getContext('2d');
            const intensityCounts = [1, 2, 3, 4].map(level => incidents.filter(i => i.intensity === level).length);
            charts.intensity = new Chart(intensityCtx, {
                type: 'pie',
                data: {
                    labels: ['1 (Low)', '2 (Moderate)', '3 (High)', '4 (Severe)'],
                    datasets: [{
                        data: intensityCounts,
                        backgroundColor: ['rgba(5, 150, 105, 0.6)', 'rgba(251, 191, 36, 0.6)', 'rgba(239, 68, 68, 0.6)', 'rgba(120, 50, 100, 0.6)']
                    }]
                },
                options: { responsive: true, plugins: { title: { display: true, text: 'Incident Intensity Distribution' } } }
            });
        }

        function renderIncidentLog() {
            const logEl = document.getElementById('incident-log');
            if (incidents.length === 0) {
                logEl.innerHTML = '<p class="text-center text-gray-500">No incidents logged yet.</p>';
                return;
            }
            logEl.innerHTML = incidents.map(inc => `
                <div class="p-4 border rounded-lg bg-gray-50">
                    <p class="font-semibold">${inc.timestamp.toLocaleString()}</p>
                    <p><strong>Setting:</strong> ${inc.setting} | <strong>Intensity:</strong> ${inc.intensity}</p>
                    <p><strong>Behaviors:</strong> ${inc.behaviors.map(b => `${b.name} (${b.type === 'duration' ? `${b.value}s` : `x${b.value}`})`).join(', ') || 'None'}</p>
                    <p><strong>Replacement:</strong> ${inc.replacementBehavior}</p>
                    ${inc.cooldown.duration > 0 ? `<p><strong>Cooldown:</strong> ${inc.cooldown.duration}s (${inc.cooldown.support})</p>` : ''}
                    ${inc.notes ? `<p class="mt-2 pt-2 border-t text-sm italic text-gray-700"><strong>Note:</strong> ${inc.notes}</p>` : ''}
                </div>
            `).join('');
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text("Catalyst Behavior Report", 14, 22);
            doc.setFontSize(14);
            doc.text(`Student: ${currentStudent.name}`, 14, 32);
            doc.setFontSize(10);
            doc.text(`Report Generated: ${new Date().toLocaleDateString()}`, 14, 38);

            const tableData = incidents.map(inc => [
                inc.timestamp.toLocaleString(),
                inc.setting,
                inc.intensity,
                inc.behaviors.map(b => `${b.name} (${b.type === 'duration' ? `${b.value}s` : `x${b.value}`})`).join('\n'),
                inc.replacementBehavior,
                inc.notes || "N/A"
            ]);

            doc.autoTable({
                head: [['Timestamp', 'Setting', 'Intensity', 'Behaviors', 'Replacement', 'Notes']],
                body: tableData,
                startY: 50,
                theme: 'grid'
            });

            doc.save(`Catalyst-Report-${currentStudent.name.replace(' ', '_')}-${new Date().toISOString().split('T')[0]}.pdf`);
        }


        // --- SETTINGS VIEW LOGIC ---
        async function handleAddStudent(e) {
            e.preventDefault();
            const nameInput = document.getElementById('student-name');
            const name = nameInput.value.trim();
            if (name) {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/students`), { name });
                nameInput.value = '';
            }
        }
        
        async function handleDeleteStudent(e) {
            if (!e.target.classList.contains('delete-student-btn')) return;
            const studentId = e.target.dataset.id;
            const student = students.find(s => s.id === studentId);
            showConfirmationModal(`Are you sure you want to delete ${student.name}? This will also delete all associated incident data and cannot be undone.`, async () => {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/students`, studentId));
            });
        }

        async function handleAddBehavior(e) {
            e.preventDefault();
            const name = document.getElementById('behavior-name').value.trim();
            const definition = document.getElementById('behavior-definition').value.trim();
            const type = document.getElementById('behavior-type').value;
            if (name && definition) {
                await addDoc(collection(db, `artifacts/${appId}/public/data/behaviors`), { name, definition, type });
                e.target.reset();
            }
        }

        async function handleDeleteBehavior(e) {
            if (!e.target.classList.contains('delete-behavior-btn')) return;
            const behaviorId = e.target.dataset.id;
            const behavior = behaviors.find(b => b.id === behaviorId);
            showConfirmationModal(`Are you sure you want to delete the behavior "${behavior.name}"? This will affect all users of this app.`, async () => {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/behaviors`, behaviorId));
            });
        }

        async function handleAddSetting(e) {
            e.preventDefault();
            const name = document.getElementById('setting-name').value.trim();
            if (name) {
                await addDoc(collection(db, `artifacts/${appId}/public/data/settings`), { name });
                e.target.reset();
            }
        }

        async function handleDeleteSetting(e) {
             if (!e.target.classList.contains('delete-setting-btn')) return;
            const settingId = e.target.dataset.id;
            const setting = settings.find(s => s.id === settingId);
            showConfirmationModal(`Are you sure you want to delete the setting "${setting.name}"? This will affect all users of this app.`, async () => {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/settings`, settingId));
            });
        }
        
        // --- MODAL LOGIC ---
        function showNotesModal() {
            const modal = document.getElementById('notes-modal');
            const textarea = document.getElementById('modal-notes-textarea');
            textarea.value = currentIncidentData.notes || '';
            modal.classList.remove('hidden');
        }

        function hideNotesModal() {
            document.getElementById('notes-modal').classList.add('hidden');
        }

        function saveNote() {
            currentIncidentData.notes = document.getElementById('modal-notes-textarea').value;
            const preview = document.getElementById('note-preview');
            preview.textContent = currentIncidentData.notes ? (currentIncidentData.notes.substring(0, 50) + '...') : 'Click to add a note...';
            if (currentIncidentData.notes) {
                preview.classList.remove('italic', 'text-gray-600');
                preview.classList.add('text-gray-900');
            }
            hideNotesModal();
        }
        
        let confirmCallback = null;
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }


        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            // Student selection
            const studentCard = e.target.closest('.student-card');
            if (studentCard) {
                navigateTo('logging', studentCard.dataset.id);
            }
            
            // Logging view interactions
            if (loggingView.style.display !== 'none') {
                handleBehaviorClick(e);
                
                if (e.target.closest('.intensity-btn')) {
                    document.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('bg-indigo-200'));
                    e.target.closest('.intensity-btn').classList.add('bg-indigo-200');
                    currentIncidentData.intensity = parseInt(e.target.closest('.intensity-btn').dataset.intensity);
                }

                if (e.target.closest('.replacement-btn')) {
                    document.querySelectorAll('.replacement-btn').forEach(btn => btn.classList.remove('bg-indigo-200'));
                    e.target.closest('.replacement-btn').classList.add('bg-indigo-200');
                    currentIncidentData.replacementBehavior = e.target.closest('.replacement-btn').dataset.replacement;
                }
                
                if (e.target.id === 'cooldown-start-btn') toggleCooldownTimer();
                if (e.target.id === 'note-preview') showNotesModal();
                if (e.target.id === 'save-incident-btn') saveIncident();
            }
            
            // Settings view delete buttons
            if (settingsView.style.display !== 'none') {
                handleDeleteStudent(e);
                handleDeleteBehavior(e);
                handleDeleteSetting(e);
            }
            
             // Dashboard view PDF button
            if (dashboardView.style.display !== 'none' && e.target.closest('#generate-pdf-btn')) {
                generatePDF();
            }
        });
        
        // Settings form submissions
        document.getElementById('add-student-form').addEventListener('submit', handleAddStudent);
        document.getElementById('add-behavior-form').addEventListener('submit', handleAddBehavior);
        document.getElementById('add-setting-form').addEventListener('submit', handleAddSetting);
        
        // Notes Modal Listeners
        document.getElementById('save-note-btn').addEventListener('click', saveNote);
        document.getElementById('cancel-note-btn').addEventListener('click', hideNotesModal);
        
        // Confirmation Modal Listeners
        document.getElementById('confirm-yes-btn').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmationModal();
        });
        document.getElementById('confirm-no-btn').addEventListener('click', hideConfirmationModal);

        // --- START THE APP ---
        main();

    </script>
</body>
</html>
